<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ‹–æ‹½æœ€ç»ˆè°ƒè¯•</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: monospace;
    }

    #console {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.95);
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      font-size: 11px;
      width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 10000;
    }

    .log { margin: 1px 0; white-space: pre-wrap; word-break: break-all; }
    .log.error { color: #f00; }
    .log.warn { color: #ff0; }
    .log.info { color: #0ff; }

    #box {
      position: absolute;
      left: 200px;
      top: 200px;
      width: 250px;
      height: 180px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border: 4px solid #ffff00;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
      cursor: move;
      user-select: none;
      box-shadow: 0 15px 40px rgba(0,0,0,0.6);
      transition: transform 0.1s;
    }

    #box:hover {
      transform: scale(1.02);
    }

    #status {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.9);
      color: #0ff;
      padding: 15px;
      border-radius: 8px;
      font-size: 13px;
      max-width: 400px;
    }

    .title {
      color: #ff0;
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #444;
    }

    .good { color: #0f0; }
    .bad { color: #f00; }
  </style>
</head>
<body>
  <div id="console">
    <div class="title">æ§åˆ¶å°è¾“å‡º</div>
  </div>

  <div id="status">
    <div class="title">çŠ¶æ€ç›‘æ§</div>
    <div>SDK: <span id="sdkStatus">æ£€æŸ¥ä¸­...</span></div>
    <div>äº¤äº’: <span id="interactionStatus">-</span></div>
    <div>æ‹–æ‹½: <span id="dragStatus">ç©ºé—²</span></div>
  </div>

  <div id="box">
    æ‹–åŠ¨æˆ‘ï¼<br>
    <small style="font-size:14px; margin-top:10px;">
      é»„è‰²è¾¹æ¡†<br>
      ç‚¹å‡»å¹¶æ‹–åŠ¨
    </small>
  </div>

  <script>
    const consoleDiv = document.getElementById('console');
    const sdkStatus = document.getElementById('sdkStatus');
    const interactionStatus = document.getElementById('interactionStatus');
    const dragStatus = document.getElementById('dragStatus');
    
    let logCount = 0;
    const MAX_LOGS = 200;

    // æ‹¦æˆª console.log
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);
      
      const msg = args.map(a => {
        if (typeof a === 'object') {
          try { return JSON.stringify(a); }
          catch(e) { return String(a); }
        }
        return String(a);
      }).join(' ');
      
      // æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
      const div = document.createElement('div');
      div.className = 'log';
      
      // æ ¹æ®å†…å®¹ç€è‰²
      if (msg.includes('ERROR') || msg.includes('âŒ')) {
        div.className += ' error';
      } else if (msg.includes('WARN') || msg.includes('âš ï¸')) {
        div.className += ' warn';
      } else if (msg.includes('[Drag] START') || msg.includes('[Drag] END')) {
        div.className += ' info';
        div.style.fontWeight = 'bold';
      }
      
      div.textContent = `[${++logCount}] ${msg}`;
      consoleDiv.appendChild(div);
      
      // é™åˆ¶æ•°é‡
      while (consoleDiv.children.length > MAX_LOGS) {
        consoleDiv.removeChild(consoleDiv.children[1]); // ä¿ç•™æ ‡é¢˜
      }
      
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    };

    // æ‹¦æˆª console.error
    const originalError = console.error;
    console.error = function(...args) {
      originalError.apply(console, args);
      const msg = args.join(' ');
      console.log('âŒ ERROR: ' + msg);
    };

    console.log('=== æ‹–æ‹½æœ€ç»ˆè°ƒè¯• ===');
    console.log('é¡µé¢åŠ è½½å®Œæˆ');

    // æ£€æŸ¥ SDK
    let checkCount = 0;
    function checkSDK() {
      checkCount++;
      
      if (window.AnyWP) {
        console.log('âœ… AnyWP SDK å·²åŠ è½½');
        console.log('ç‰ˆæœ¬: ' + window.AnyWP.version);
        console.log('DPI: ' + window.AnyWP.dpiScale);
        console.log('äº¤äº’: ' + window.AnyWP.interactionEnabled);
        
        sdkStatus.textContent = 'v' + window.AnyWP.version;
        sdkStatus.className = 'good';
        interactionStatus.textContent = window.AnyWP.interactionEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨';
        interactionStatus.className = window.AnyWP.interactionEnabled ? 'good' : 'bad';
        
        if (typeof window.AnyWP.makeDraggable === 'function') {
          console.log('âœ… makeDraggable æ–¹æ³•å­˜åœ¨');
          setupDrag();
        } else {
          console.log('âŒ makeDraggable æ–¹æ³•ä¸å­˜åœ¨');
          sdkStatus.textContent = 'æ–¹æ³•ç¼ºå¤±';
          sdkStatus.className = 'bad';
        }
      } else {
        if (checkCount % 10 === 1) {
          console.log('â³ ç­‰å¾… AnyWP SDK... (' + checkCount + ')');
        }
        
        if (checkCount < 100) {
          setTimeout(checkSDK, 100);
        } else {
          console.log('âŒ SDK åŠ è½½è¶…æ—¶');
          sdkStatus.textContent = 'åŠ è½½å¤±è´¥';
          sdkStatus.className = 'bad';
        }
      }
    }

    // ç›‘å¬é¼ æ ‡äº‹ä»¶
    let lastEventType = null;
    window.addEventListener('AnyWP:mouse', function(e) {
      const type = e.detail.type;
      
      // åªè®°å½•çŠ¶æ€å˜åŒ–
      if (type !== lastEventType && type !== 'mousemove') {
        console.log('ğŸ–±ï¸ ' + type + ' at (' + e.detail.x + ', ' + e.detail.y + ')');
        lastEventType = type;
      }
    });

    // è®¾ç½®æ‹–æ‹½
    function setupDrag() {
      console.log('--- å¼€å§‹è®¾ç½®æ‹–æ‹½ ---');
      
      try {
        // å¼ºåˆ¶å¯ç”¨äº¤äº’
        window.AnyWP.interactionEnabled = true;
        window.AnyWP._debugMode = true;
        
        console.log('è°ƒç”¨ makeDraggable...');
        
        window.AnyWP.makeDraggable('#box', {
          persistKey: 'final_test_box',
          onDragStart: function(pos) {
            console.log('ğŸ¯ [å›è°ƒ] æ‹–æ‹½å¼€å§‹ï¼ä½ç½®: ' + JSON.stringify(pos));
            dragStatus.textContent = 'æ‹–æ‹½ä¸­';
            dragStatus.className = 'good';
            document.getElementById('box').style.transform = 'scale(1.1) rotate(2deg)';
            document.getElementById('box').style.boxShadow = '0 20px 60px rgba(255,0,0,0.8)';
          },
          onDrag: function(pos) {
            // ä¸è®°å½•æ¯æ¬¡ç§»åŠ¨
          },
          onDragEnd: function(pos) {
            console.log('ğŸ¯ [å›è°ƒ] æ‹–æ‹½ç»“æŸï¼ä½ç½®: ' + JSON.stringify(pos));
            dragStatus.textContent = 'ç©ºé—²';
            dragStatus.className = '';
            document.getElementById('box').style.transform = 'scale(1)';
            document.getElementById('box').style.boxShadow = '0 15px 40px rgba(0,0,0,0.6)';
          }
        });
        
        console.log('âœ… makeDraggable è°ƒç”¨å®Œæˆ');
        
        const box = document.getElementById('box');
        if (box.__anyWP_dragHandler) {
          console.log('âœ… æ‹–æ‹½å¤„ç†å™¨å·²ç»‘å®š');
        } else {
          console.log('âŒ æ‹–æ‹½å¤„ç†å™¨æœªç»‘å®š');
        }
        
        console.log('');
        console.log('ğŸ“Œ è¯·ç‚¹å‡»é»„è‰²æ–¹å—å¹¶æ‹–åŠ¨');
        console.log('ğŸ“Œ æŸ¥çœ‹æ­¤é¢æ¿çš„è¾“å‡ºæ—¥å¿—');
        
      } catch (err) {
        console.log('âŒ é”™è¯¯: ' + err.message);
        console.log(err.stack);
      }
    }

    // å¼€å§‹
    checkSDK();

    // å®šæ—¶æ£€æŸ¥æ‹–æ‹½çŠ¶æ€
    setInterval(function() {
      if (window.AnyWP && window.AnyWP._dragState) {
        dragStatus.textContent = 'æ‹–æ‹½ä¸­ (' + 
          Math.round(window.AnyWP._dragState.startX) + ',' + 
          Math.round(window.AnyWP._dragState.startY) + ')';
        dragStatus.className = 'good';
      }
    }, 100);
  </script>
</body>
</html>

