<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æ‹–æ‹½åæ ‡è°ƒè¯•</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: monospace;
    }

    #debugPanel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.95);
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      font-size: 12px;
      max-width: 450px;
      max-height: 90vh;
      overflow-y: auto;
      z-index: 10000;
    }

    .log { margin: 2px 0; white-space: pre-wrap; }
    .error { color: #f00; }
    .success { color: #0f0; }
    .warning { color: #ff0; }
    .info { color: #0ff; }

    #box {
      position: absolute;
      left: 100px;
      top: 100px;
      width: 200px;
      height: 150px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border: 3px solid yellow;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      font-weight: bold;
      cursor: move;
      user-select: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    #coords {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.9);
      color: #0ff;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="debugPanel">
    <div class="log warning">ç­‰å¾…åˆå§‹åŒ–...</div>
  </div>

  <div id="coords">
    é¼ æ ‡: (0, 0) | å…ƒç´ : [0,0] - [0,0] | å‘½ä¸­: NO
  </div>

  <div id="box">
    æ‹–åŠ¨æˆ‘ï¼<br>
    <small>(é»„è‰²è¾¹æ¡†)</small>
  </div>

  <script>
    const panel = document.getElementById('debugPanel');
    const coords = document.getElementById('coords');
    const box = document.getElementById('box');
    
    let logNum = 0;
    function log(msg, type = 'log') {
      console.log('[Debug] ' + msg);
      const div = document.createElement('div');
      div.className = 'log ' + type;
      div.textContent = `[${++logNum}] ${msg}`;
      panel.appendChild(div);
      if (panel.children.length > 80) {
        panel.removeChild(panel.children[1]);
      }
      panel.scrollTop = panel.scrollHeight;
    }

    panel.innerHTML = '';
    log('=== åæ ‡è°ƒè¯•æµ‹è¯• ===', 'warning');
    
    // è·å–å…ƒç´ åˆå§‹ä½ç½®
    function getBoxBounds() {
      const rect = box.getBoundingClientRect();
      const dpi = window.devicePixelRatio || 1;
      return {
        cssLeft: rect.left,
        cssTop: rect.top,
        cssRight: rect.right,
        cssBottom: rect.bottom,
        physicalLeft: Math.round(rect.left * dpi),
        physicalTop: Math.round(rect.top * dpi),
        physicalRight: Math.round(rect.right * dpi),
        physicalBottom: Math.round(rect.bottom * dpi),
        dpi: dpi
      };
    }

    const bounds = getBoxBounds();
    log('DPI: ' + bounds.dpi, 'info');
    log('CSS ä½ç½®: (' + bounds.cssLeft + ', ' + bounds.cssTop + ')', 'info');
    log('ç‰©ç†ä½ç½®: (' + bounds.physicalLeft + ', ' + bounds.physicalTop + ')', 'info');
    log('CSS å°ºå¯¸: ' + (bounds.cssRight - bounds.cssLeft) + ' x ' + (bounds.cssBottom - bounds.cssTop), 'info');
    log('ç‰©ç†å°ºå¯¸: ' + (bounds.physicalRight - bounds.physicalLeft) + ' x ' + (bounds.physicalBottom - bounds.physicalTop), 'info');

    // ç›‘å¬é¼ æ ‡äº‹ä»¶
    let lastMouseEvent = null;
    let mouseEventCount = 0;
    
    window.addEventListener('AnyWP:mouse', function(e) {
      const detail = e.detail;
      lastMouseEvent = detail;
      mouseEventCount++;
      
      // è·å–å½“å‰è¾¹ç•Œ
      const bounds = getBoxBounds();
      
      // æ£€æŸ¥æ˜¯å¦å‘½ä¸­
      const hit = detail.x >= bounds.physicalLeft && 
                  detail.x <= bounds.physicalRight &&
                  detail.y >= bounds.physicalTop && 
                  detail.y <= bounds.physicalBottom;
      
      // æ›´æ–°åæ ‡æ˜¾ç¤º
      coords.innerHTML = `é¼ æ ‡: (${detail.x}, ${detail.y}) | ` +
                        `å…ƒç´ : [${bounds.physicalLeft},${bounds.physicalTop}] - [${bounds.physicalRight},${bounds.physicalBottom}] | ` +
                        `å‘½ä¸­: ${hit ? '<span style="color:#0f0">YES</span>' : '<span style="color:#f00">NO</span>'}`;
      
      // è®°å½•é mousemove äº‹ä»¶
      if (detail.type !== 'mousemove') {
        log(`${detail.type} at (${detail.x}, ${detail.y}) - Hit: ${hit}`, 
            hit ? 'success' : 'warning');
        
        if (hit) {
          log(`  å…ƒç´ è¾¹ç•Œ: [${bounds.physicalLeft},${bounds.physicalTop}] - [${bounds.physicalRight},${bounds.physicalBottom}]`, 'info');
        }
      }
      
      // æ¯100ä¸ªäº‹ä»¶è®°å½•ä¸€æ¬¡çŠ¶æ€
      if (mouseEventCount % 100 === 0) {
        log(`å·²æ¥æ”¶ ${mouseEventCount} ä¸ªé¼ æ ‡äº‹ä»¶`, 'info');
      }
    });

    // æ£€æŸ¥ AnyWP
    function checkSDK() {
      if (window.AnyWP) {
        log('âœ… AnyWP å·²åŠ è½½', 'success');
        log('ç‰ˆæœ¬: ' + window.AnyWP.version, 'info');
        log('äº¤äº’: ' + window.AnyWP.interactionEnabled, window.AnyWP.interactionEnabled ? 'success' : 'error');
        log('DPI Scale: ' + window.AnyWP.dpiScale, 'info');
        
        // æ£€æŸ¥æ–¹æ³•
        if (typeof window.AnyWP.makeDraggable === 'function') {
          log('âœ… makeDraggable å­˜åœ¨', 'success');
          setupDrag();
        } else {
          log('âŒ makeDraggable ä¸å­˜åœ¨', 'error');
        }
      } else {
        log('ç­‰å¾… AnyWP...', 'warning');
        setTimeout(checkSDK, 100);
      }
    }

    function setupDrag() {
      log('--- è®¾ç½®æ‹–æ‹½ ---', 'warning');
      
      try {
        // å¼ºåˆ¶å¯ç”¨äº¤äº’
        if (!window.AnyWP.interactionEnabled) {
          window.AnyWP.interactionEnabled = true;
          log('å·²å¯ç”¨äº¤äº’', 'warning');
        }
        
        // å¯ç”¨è°ƒè¯•æ¨¡å¼
        window.AnyWP._debugMode = true;
        
        window.AnyWP.makeDraggable('#box', {
          persistKey: 'debug_box_pos',
          onDragStart: function(pos) {
            log('ğŸ¯ æ‹–æ‹½å¼€å§‹ï¼', 'success');
            log('  ä½ç½®: ' + JSON.stringify(pos), 'info');
            box.style.boxShadow = '0 20px 50px rgba(255,0,0,0.8)';
          },
          onDrag: function(pos) {
            // æ¯10æ¬¡è®°å½•ä¸€æ¬¡
            if (Math.random() < 0.1) {
              log('  æ‹–æ‹½ä¸­: (' + Math.round(pos.x) + ', ' + Math.round(pos.y) + ')', 'info');
            }
          },
          onDragEnd: function(pos) {
            log('ğŸ¯ æ‹–æ‹½ç»“æŸï¼', 'success');
            log('  æœ€ç»ˆä½ç½®: ' + JSON.stringify(pos), 'info');
            box.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)';
          }
        });
        
        log('âœ… makeDraggable è°ƒç”¨æˆåŠŸ', 'success');
        
        // éªŒè¯å¤„ç†å™¨
        if (box.__anyWP_dragHandler) {
          log('âœ… æ‹–æ‹½å¤„ç†å™¨å·²ç»‘å®š', 'success');
        } else {
          log('âŒ æ‹–æ‹½å¤„ç†å™¨æœªç»‘å®š', 'error');
        }
        
        // æ˜¾ç¤ºè¯´æ˜
        log('', 'info');
        log('ğŸ“Œ æ“ä½œè¯´æ˜:', 'warning');
        log('1. ç§»åŠ¨é¼ æ ‡åˆ°é»„è‰²æ–¹å—ä¸Š', 'info');
        log('2. æŸ¥çœ‹ä¸‹æ–¹åæ ‡æ˜¾ç¤º "å‘½ä¸­: YES"', 'info');
        log('3. æŒ‰ä½é¼ æ ‡å·¦é”®æ‹–åŠ¨', 'info');
        log('4. æ¾å¼€é¼ æ ‡å®Œæˆæ‹–æ‹½', 'info');
        
      } catch (err) {
        log('âŒ é”™è¯¯: ' + err.message, 'error');
        log(err.stack, 'error');
      }
    }

    // å¯åŠ¨
    log('å¼€å§‹æ£€æŸ¥ SDK...');
    checkSDK();

    // å®šæ—¶æ˜¾ç¤ºæ‹–æ‹½çŠ¶æ€
    setInterval(function() {
      if (window.AnyWP && window.AnyWP._dragState) {
        const state = window.AnyWP._dragState;
        log('ğŸ”µ æ‹–æ‹½çŠ¶æ€: å¼€å§‹(' + state.startX + ',' + state.startY + ')', 'info');
      }
    }, 500);
  </script>
</body>
</html>

