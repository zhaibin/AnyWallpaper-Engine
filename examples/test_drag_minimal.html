<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æœ€å°æ‹–æ‹½æµ‹è¯•</title>
  <style>
    * { margin: 0; padding: 0; }
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: Arial, sans-serif;
    }

    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.9);
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      max-width: 400px;
      z-index: 10000;
      max-height: 90vh;
      overflow-y: auto;
    }

    .log { margin: 3px 0; }
    .error { color: #f00; }
    .success { color: #0f0; }
    .warning { color: #ff0; }

    #box {
      position: absolute;
      left: 500px;
      top: 300px;
      width: 200px;
      height: 150px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      cursor: move;
      user-select: none;
    }

    #instructions {
      position: absolute;
      top: 50px;
      right: 50px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 300px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    }

    #instructions h2 {
      color: #667eea;
      margin-bottom: 10px;
    }

    #instructions p {
      margin: 8px 0;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div id="info">
    <div class="log warning">åˆå§‹åŒ–ä¸­...</div>
  </div>

  <div id="instructions">
    <h2>ğŸ¯ æ‹–æ‹½æµ‹è¯•</h2>
    <p><strong>æ“ä½œï¼š</strong>æ‹–åŠ¨ç²‰çº¢è‰²æ–¹å—</p>
    <p><strong>æŸ¥çœ‹ï¼š</strong>å·¦ä¸Šè§’æ˜¾ç¤ºæ‰€æœ‰äº‹ä»¶</p>
    <p><strong>çŠ¶æ€ï¼š</strong><span id="status">æ£€æŸ¥ä¸­...</span></p>
  </div>

  <div id="box">
    æ‹–æˆ‘ï¼
  </div>

  <script>
    const info = document.getElementById('info');
    const status = document.getElementById('status');
    let logCount = 0;

    function log(msg, type = 'log') {
      console.log('[Test] ' + msg);
      const div = document.createElement('div');
      div.className = 'log ' + type;
      div.textContent = `[${++logCount}] ${msg}`;
      info.appendChild(div);
      if (info.children.length > 100) {
        info.removeChild(info.children[1]);
      }
      info.scrollTop = info.scrollHeight;
    }

    // æ¸…ç©ºåˆå§‹æ¶ˆæ¯
    info.innerHTML = '';
    
    log('=== æ‹–æ‹½æœ€å°æµ‹è¯• ===', 'warning');
    log('é¡µé¢åŠ è½½å®Œæˆ');
    log('DPI: ' + window.devicePixelRatio);

    // ç«‹å³æ£€æŸ¥ AnyWP
    let checkCount = 0;
    const maxChecks = 100;
    
    function checkAnyWP() {
      checkCount++;
      
      if (window.AnyWP) {
        log('âœ… AnyWP æ‰¾åˆ°äº†ï¼', 'success');
        log('ç‰ˆæœ¬: ' + window.AnyWP.version, 'success');
        log('DPI Scale: ' + window.AnyWP.dpiScale);
        log('å±å¹•: ' + window.AnyWP.screenWidth + 'x' + window.AnyWP.screenHeight);
        log('äº¤äº’: ' + window.AnyWP.interactionEnabled, window.AnyWP.interactionEnabled ? 'success' : 'error');
        
        status.textContent = 'SDK å·²åŠ è½½';
        status.style.color = 'green';
        
        // æ£€æŸ¥æ–¹æ³•
        if (typeof window.AnyWP.makeDraggable === 'function') {
          log('âœ… makeDraggable å­˜åœ¨', 'success');
          setupDrag();
        } else {
          log('âŒ makeDraggable ä¸å­˜åœ¨', 'error');
          status.textContent = 'SDK ç¼ºå°‘æ–¹æ³•';
        }
      } else {
        if (checkCount <= 10 || checkCount % 10 === 0) {
          log(`â³ ç­‰å¾… AnyWP... (${checkCount}/${maxChecks})`, 'warning');
        }
        
        if (checkCount < maxChecks) {
          setTimeout(checkAnyWP, 100);
        } else {
          log('âŒ AnyWP è¶…æ—¶æœªåŠ è½½', 'error');
          log('SDK å¯èƒ½æœªæ³¨å…¥æˆ–æœ‰é”™è¯¯', 'error');
          status.textContent = 'SDK åŠ è½½å¤±è´¥';
          status.style.color = 'red';
        }
      }
    }

    // ç›‘å¬é¼ æ ‡äº‹ä»¶ï¼ˆæ¥è‡ª C++ é’©å­ï¼‰
    let mouseCount = 0;
    window.addEventListener('AnyWP:mouse', function(e) {
      mouseCount++;
      
      // åªè®°å½•éƒ¨åˆ† mousemoveï¼Œå…¨éƒ¨è®°å½•å…¶ä»–äº‹ä»¶
      if (e.detail.type !== 'mousemove' || mouseCount % 20 === 0) {
        log(`ğŸ–±ï¸ ${e.detail.type} (${e.detail.x}, ${e.detail.y})`, 
            e.detail.type === 'mousemove' ? 'log' : 'warning');
      }
    });

    // è®¾ç½®æ‹–æ‹½
    function setupDrag() {
      log('--- å¼€å§‹è®¾ç½®æ‹–æ‹½ ---', 'warning');
      
      try {
        // ç¡®ä¿äº¤äº’å¯ç”¨
        if (!window.AnyWP.interactionEnabled) {
          log('âš ï¸ äº¤äº’æœªå¯ç”¨ï¼Œæ­£åœ¨å¯ç”¨...', 'warning');
          window.AnyWP.interactionEnabled = true;
        }
        
        log('è°ƒç”¨ makeDraggable...');
        
        window.AnyWP.makeDraggable('#box', {
          persistKey: 'minimal_test_box',
          onDragStart: function(pos) {
            log('ğŸ¯ [å›è°ƒ] æ‹–æ‹½å¼€å§‹: ' + JSON.stringify(pos), 'success');
            document.getElementById('box').style.transform = 'scale(1.05)';
          },
          onDrag: function(pos) {
            // ä¸è®°å½•ï¼Œå¤ªå¤šäº†
          },
          onDragEnd: function(pos) {
            log('ğŸ¯ [å›è°ƒ] æ‹–æ‹½ç»“æŸ: ' + JSON.stringify(pos), 'success');
            document.getElementById('box').style.transform = 'scale(1)';
          }
        });
        
        log('âœ… makeDraggable è°ƒç”¨å®Œæˆ', 'success');
        
        // æ£€æŸ¥æ˜¯å¦æˆåŠŸæ³¨å†Œ
        const box = document.getElementById('box');
        if (box.__anyWP_dragHandler) {
          log('âœ… æ‹–æ‹½å¤„ç†å™¨å·²ç»‘å®š', 'success');
          status.textContent = 'å‡†å¤‡å°±ç»ª - å¯ä»¥æ‹–æ‹½ï¼';
          status.style.color = 'green';
        } else {
          log('âŒ æ‹–æ‹½å¤„ç†å™¨æœªç»‘å®š', 'error');
          status.textContent = 'è®¾ç½®å¤±è´¥';
        }
        
        // æ˜¾ç¤ºå…ƒç´ ä½ç½®
        const rect = box.getBoundingClientRect();
        log(`å…ƒç´ ä½ç½®: left=${rect.left}, top=${rect.top}, width=${rect.width}, height=${rect.height}`);
        
      } catch (err) {
        log('âŒ é”™è¯¯: ' + err.message, 'error');
        log('Stack: ' + err.stack, 'error');
        status.textContent = 'è®¾ç½®å‡ºé”™';
        status.style.color = 'red';
      }
    }

    // å¼€å§‹æ£€æŸ¥
    log('å¼€å§‹æ£€æŸ¥ AnyWP...');
    checkAnyWP();

    // å®šæ—¶è¾“å‡ºçŠ¶æ€
    setInterval(function() {
      if (window.AnyWP && window.AnyWP._dragState) {
        log('ğŸ“ æ­£åœ¨æ‹–æ‹½ä¸­...', 'warning');
      }
    }, 1000);
  </script>
</body>
</html>

