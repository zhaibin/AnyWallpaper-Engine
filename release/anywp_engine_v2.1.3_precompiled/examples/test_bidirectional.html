<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒå‘é€šä¿¡æµ‹è¯• - AnyWP Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            background: #667eea;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #48bb78;
        }

        button.secondary:hover {
            background: #38a169;
        }

        button.danger {
            background: #f56565;
        }

        button.danger:hover {
            background: #e53e3e;
        }

        .log-container {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            line-height: 1.5;
        }

        .log-entry.send {
            background: #e6fffa;
            border-left: 3px solid #38b2ac;
        }

        .log-entry.receive {
            background: #fef5e7;
            border-left: 3px solid #f6ad55;
        }

        .log-entry.info {
            background: #ebf8ff;
            border-left: 3px solid #4299e1;
        }

        .log-entry.error {
            background: #fff5f5;
            border-left: 3px solid #f56565;
        }

        .timestamp {
            color: #718096;
            font-size: 11px;
            margin-right: 8px;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .status.disconnected {
            background: #fed7d7;
            color: #742a2a;
        }

        .counter {
            display: inline-block;
            background: #edf2f7;
            padding: 8px 16px;
            border-radius: 6px;
            margin: 5px;
            font-weight: 600;
        }

        .counter span {
            color: #667eea;
            font-size: 1.2em;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ åŒå‘é€šä¿¡æµ‹è¯•</h1>

        <!-- çŠ¶æ€é¢æ¿ -->
        <div class="panel">
            <h2>ğŸ“Š è¿æ¥çŠ¶æ€</h2>
            <div id="status" class="status disconnected">æœªè¿æ¥</div>
            <div>
                <div class="counter">å‘é€: <span id="sendCount">0</span></div>
                <div class="counter">æ¥æ”¶: <span id="receiveCount">0</span></div>
            </div>
        </div>

        <!-- å‘é€æ¶ˆæ¯é¢æ¿ -->
        <div class="panel">
            <h2>ğŸ“¤ å‘é€æ¶ˆæ¯åˆ° Flutter</h2>
            <div class="button-group">
                <button id="btnTest">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
                <button id="btnCarousel" class="secondary">å‘é€è½®æ’­çŠ¶æ€</button>
                <button id="btnHeartbeat" class="secondary">å‘é€å¿ƒè·³</button>
                <button id="btnError" class="danger">å‘é€é”™è¯¯</button>
            </div>
            <input type="text" id="customMessage" placeholder="è‡ªå®šä¹‰æ¶ˆæ¯ (JSONæ ¼å¼)">
            <button id="btnCustom">å‘é€è‡ªå®šä¹‰æ¶ˆæ¯</button>
        </div>

        <!-- æ¥æ”¶æ¶ˆæ¯é¢æ¿ -->
        <div class="panel">
            <h2>ğŸ“¥ æ¥æ”¶ Flutter æ¶ˆæ¯</h2>
            <div class="button-group">
                <button id="btnClear">æ¸…ç©ºæ—¥å¿—</button>
                <button id="btnAutoScroll" class="secondary">
                    <span id="autoScrollText">è‡ªåŠ¨æ»šåŠ¨: å¼€</span>
                </button>
            </div>
            <div id="logContainer" class="log-container"></div>
        </div>
    </div>

    <script src="../windows/anywp_sdk.js"></script>
    <script>
        let sendCount = 0;
        let receiveCount = 0;
        let autoScroll = true;
        let messageId = 1;

        // ç­‰å¾… SDK åŠ è½½
        function waitForSDK() {
            if (typeof window.AnyWP === 'undefined') {
                console.log('[Test] Waiting for SDK...');
                setTimeout(waitForSDK, 100);
                return;
            }
            
            initializePage();
        }

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            addLog('info', 'SDK åˆå§‹åŒ–å®Œæˆï¼Œç‰ˆæœ¬: ' + window.AnyWP.version);
            
            // å¯ç”¨è°ƒè¯•æ¨¡å¼
            window.AnyWP.enableDebug();
            addLog('info', 'è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
            
            // æ£€æŸ¥ WebView2 è¿æ¥
            if (window.chrome && window.chrome.webview) {
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'å·²è¿æ¥';
                addLog('info', 'WebView2 æ¡¥æ¥å·²å°±ç»ª');
            } else {
                addLog('error', 'WebView2 ä¸å¯ç”¨ï¼Œè¯·åœ¨ AnyWP Engine ä¸­è¿è¡Œ');
            }

            // è®¾ç½®æ¶ˆæ¯æ¥æ”¶å›è°ƒ
            window.AnyWP.onMessage((message) => {
                receiveCount++;
                updateCounter('receiveCount', receiveCount);
                
                addLog('receive', 'æ¥æ”¶åˆ° Flutter æ¶ˆæ¯', {
                    type: message.type,
                    data: message.data,
                    timestamp: new Date(message.timestamp).toLocaleTimeString()
                });

                // è‡ªåŠ¨å›å¤
                if (message.type === 'ping') {
                    setTimeout(() => {
                        sendPong(message.data.requestId);
                    }, 100);
                }
            });

            addLog('info', 'æ¶ˆæ¯æ¥æ”¶å›è°ƒå·²è®¾ç½®');

            // å‘é€å°±ç»ªæ¶ˆæ¯
            window.AnyWP.ready('Bidirectional Test Page');
            
            // å»¶è¿Ÿæ³¨å†Œç‚¹å‡»äº‹ä»¶ï¼ˆç¡®ä¿ DOM å®Œå…¨å°±ç»ªï¼‰
            setTimeout(registerClickHandlers, 1000);
        }
        
        // æ³¨å†Œæ‰€æœ‰ç‚¹å‡»å¤„ç†å™¨
        function registerClickHandlers() {
            addLog('info', 'å¼€å§‹æ³¨å†Œç‚¹å‡»å¤„ç†å™¨...');
            
            // æ³¨å†Œæ‰€æœ‰æŒ‰é’®
            const buttons = [
                { id: 'btnTest', handler: sendTestMessage, name: 'æµ‹è¯•æ¶ˆæ¯' },
                { id: 'btnCarousel', handler: sendCarouselState, name: 'è½®æ’­çŠ¶æ€' },
                { id: 'btnHeartbeat', handler: sendHeartbeat, name: 'å¿ƒè·³' },
                { id: 'btnError', handler: sendError, name: 'é”™è¯¯' },
                { id: 'btnCustom', handler: sendCustomMessage, name: 'è‡ªå®šä¹‰æ¶ˆæ¯' },
                { id: 'btnClear', handler: clearLog, name: 'æ¸…ç©ºæ—¥å¿—' },
                { id: 'btnAutoScroll', handler: toggleAutoScroll, name: 'è‡ªåŠ¨æ»šåŠ¨' }
            ];
            
            buttons.forEach(btn => {
                try {
                    const element = document.getElementById(btn.id);
                    if (element) {
                        window.AnyWP.onClick('#' + btn.id, function(x, y) {
                            addLog('info', 'æŒ‰é’®è¢«ç‚¹å‡»: ' + btn.name + ' åæ ‡: (' + x + ',' + y + ')');
                            btn.handler();
                        }, { debug: true });
                        addLog('info', 'âœ… å·²æ³¨å†Œ: ' + btn.name);
                    }
                } catch (e) {
                    addLog('error', 'æ³¨å†Œå¤±è´¥ ' + btn.name + ': ' + e.message);
                }
            });
            
            // æ›´æ–°å¤„ç†å™¨è®¡æ•°
            const handlerCount = window.AnyWP._clickHandlers ? window.AnyWP._clickHandlers.length : 0;
            addLog('info', 'âœ… ç‚¹å‡»å¤„ç†å™¨æ³¨å†Œå®Œæˆï¼Œå…± ' + handlerCount + ' ä¸ª');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', waitForSDK);

        function sendTestMessage() {
            const success = window.AnyWP.sendToFlutter('testMessage', {
                message: 'Hello from JavaScript!',
                timestamp: Date.now(),
                testId: messageId++
            });

            if (success) {
                sendCount++;
                updateCounter('sendCount', sendCount);
                addLog('send', 'å‘é€æµ‹è¯•æ¶ˆæ¯æˆåŠŸ');
            } else {
                addLog('error', 'å‘é€æ¶ˆæ¯å¤±è´¥');
            }
        }

        function sendCarouselState() {
            const success = window.AnyWP.sendToFlutter('carouselStateChanged', {
                currentIndex: Math.floor(Math.random() * 10),
                totalImages: 10,
                isPlaying: true,
                currentImageUrl: 'https://example.com/image.jpg'
            });

            if (success) {
                sendCount++;
                updateCounter('sendCount', sendCount);
                addLog('send', 'å‘é€è½®æ’­çŠ¶æ€æˆåŠŸ');
            }
        }

        function sendHeartbeat() {
            const success = window.AnyWP.sendToFlutter('heartbeat', {
                seq: sendCount + 1,
                clientTime: Date.now()
            });

            if (success) {
                sendCount++;
                updateCounter('sendCount', sendCount);
                addLog('send', 'å‘é€å¿ƒè·³æˆåŠŸ');
            }
        }

        function sendError() {
            const success = window.AnyWP.sendToFlutter('error', {
                code: 'TEST_ERROR',
                message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯',
                details: {
                    source: 'JavaScript',
                    testMode: true
                }
            });

            if (success) {
                sendCount++;
                updateCounter('sendCount', sendCount);
                addLog('send', 'å‘é€é”™è¯¯æ¶ˆæ¯æˆåŠŸ');
            }
        }

        function sendPong(requestId) {
            const success = window.AnyWP.sendToFlutter('pong', {
                requestId: requestId,
                clientTime: Date.now()
            });

            if (success) {
                sendCount++;
                updateCounter('sendCount', sendCount);
                addLog('send', 'è‡ªåŠ¨å›å¤ pong: ' + requestId);
            }
        }

        function sendCustomMessage() {
            const input = document.getElementById('customMessage');
            const text = input.value.trim();
            
            if (!text) {
                addLog('error', 'è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
                return;
            }

            try {
                const message = JSON.parse(text);
                const success = window.AnyWP.sendToFlutter(
                    message.type || 'custom',
                    message.data || {}
                );

                if (success) {
                    sendCount++;
                    updateCounter('sendCount', sendCount);
                    addLog('send', 'å‘é€è‡ªå®šä¹‰æ¶ˆæ¯æˆåŠŸ', message);
                    input.value = '';
                }
            } catch (e) {
                addLog('error', 'æ— æ•ˆçš„ JSON æ ¼å¼: ' + e.message);
            }
        }

        function addLog(type, message, data) {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            
            const timestamp = new Date().toLocaleTimeString('zh-CN', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                fractionalSecondDigits: 3
            });
            
            let content = `<span class="timestamp">[${timestamp}]</span>${message}`;
            
            if (data) {
                content += '<br><pre style="margin-top: 4px; font-size: 12px;">' + 
                           JSON.stringify(data, null, 2) + '</pre>';
            }
            
            entry.innerHTML = content;
            logContainer.appendChild(entry);
            
            if (autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        function updateCounter(id, value) {
            document.getElementById(id).textContent = value;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('info', 'æ—¥å¿—å·²æ¸…ç©º');
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            document.getElementById('autoScrollText').textContent = 
                'è‡ªåŠ¨æ»šåŠ¨: ' + (autoScroll ? 'å¼€' : 'å…³');
        }

        // ç›‘å¬é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                sendTestMessage();
            }
        });
    </script>
</body>
</html>

