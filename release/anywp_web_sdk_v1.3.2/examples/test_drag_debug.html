<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ‹–æ‹½è°ƒè¯•æµ‹è¯•</title>
  <script src="../windows/anywp_sdk.js"></script>
  <style>
    body {
      margin: 0;
      padding: 15px;
      font-family: 'Consolas', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      overflow: hidden;
      box-sizing: border-box;
    }
    
    .info {
      background: #252526;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #3e3e42;
      border-radius: 5px;
      font-size: 14px;
      line-height: 1.8;
    }
    
    .info h3 {
      margin: 0 0 10px 0;
      color: #4ec9b0;
    }
    
    .box {
      width: 200px;
      height: 150px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: bold;
      position: absolute;
      left: 700px;
      top: 200px;
      cursor: move;
    }
    
    #log {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      padding: 10px;
      max-height: 500px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .log-line {
      margin: 3px 0;
      padding: 2px 5px;
      border-left: 3px solid #4ec9b0;
    }
    
    .log-error {
      border-left-color: #f48771;
      color: #f48771;
    }
  </style>
</head>
<body>
  <div class="info">
    <h3>ğŸ” ç³»ç»Ÿä¿¡æ¯</h3>
    <div id="system-info">æ­£åœ¨åŠ è½½...</div>
  </div>
  
  <div class="info">
    <h3>ğŸ“Š å®æ—¶è°ƒè¯•æ—¥å¿—</h3>
    <div id="log"></div>
  </div>
  
  <div id="testBox" class="box">
    æ‹–åŠ¨æˆ‘æµ‹è¯•<br>
    (Widget2 ä½ç½®)
  </div>
  
  <script>
    const logDiv = document.getElementById('log');
    
    // æ•è·æ‰€æœ‰ console.log
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    console.log = function() {
      // è°ƒç”¨åŸå§‹ console.log
      originalLog.apply(console, arguments);
      
      // ä¹Ÿæ˜¾ç¤ºåœ¨é¡µé¢ä¸Šï¼ˆä½†è·³è¿‡å¤ªé¢‘ç¹çš„æ—¥å¿—ï¼‰
      const message = Array.from(arguments).join(' ');
      if (message.indexOf('[AnyWP]') !== -1 || message.indexOf('ğŸ–±ï¸') !== -1) {
        const line = document.createElement('div');
        line.className = 'log-line';
        line.style.fontSize = '11px';
        line.style.color = '#888';
        line.textContent = message;
        logDiv.appendChild(line);
        logDiv.scrollTop = logDiv.scrollHeight;
      }
      
      // å‘é€åˆ° C++ è¾“å‡ºåˆ°æ–‡ä»¶ï¼ˆæ‰€æœ‰ console.logï¼‰
      if (window.chrome && window.chrome.webview) {
        try {
          window.chrome.webview.postMessage({
            type: 'console_log',
            level: 'info',
            message: message
          });
        } catch (e) {
          // Ignore
        }
      }
    };
    
    // æ•è·æ‰€æœ‰é”™è¯¯
    console.error = function() {
      originalError.apply(console, arguments);
      const message = 'âŒ ERROR: ' + Array.from(arguments).join(' ');
      const line = document.createElement('div');
      line.className = 'log-line log-error';
      line.textContent = message;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
      
      // å‘é€åˆ° C++
      if (window.chrome && window.chrome.webview) {
        try {
          window.chrome.webview.postMessage({
            type: 'console_log',
            level: 'error',
            message: message
          });
        } catch (e) {
          // Ignore
        }
      }
    };
    
    console.warn = function() {
      originalWarn.apply(console, arguments);
      const message = 'âš ï¸ WARN: ' + Array.from(arguments).join(' ');
      const line = document.createElement('div');
      line.className = 'log-line';
      line.style.color = '#ff9800';
      line.textContent = message;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
    };
    
    // å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('error', function(event) {
      const message = 'ğŸ’¥ Global Error: ' + event.message + ' at ' + event.filename + ':' + event.lineno;
      originalError(message, event.error);
      const line = document.createElement('div');
      line.className = 'log-line log-error';
      line.textContent = message;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
    });
    
    // æœªæ•è·çš„ Promise é”™è¯¯
    window.addEventListener('unhandledrejection', function(event) {
      const message = 'ğŸ’¥ Unhandled Promise Rejection: ' + event.reason;
      originalError(message);
      const line = document.createElement('div');
      line.className = 'log-line log-error';
      line.textContent = message;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
    });
    
    function log(message, isError) {
      const line = document.createElement('div');
      line.className = 'log-line' + (isError ? ' log-error' : '');
      line.textContent = new Date().toLocaleTimeString() + ' - ' + message;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
      originalLog(message);
      
      // ä¹Ÿå‘é€åˆ° C++ è¾“å‡ºåˆ°æ–‡ä»¶
      if (window.chrome && window.chrome.webview) {
        try {
          window.chrome.webview.postMessage({
            type: 'console_log',
            level: isError ? 'error' : 'info',
            message: message
          });
        } catch (e) {
          // Ignore if bridge not available
        }
      }
    }
    
    function updateSystemInfo() {
      const info = document.getElementById('system-info');
      info.innerHTML = 
        '<strong>window.devicePixelRatio:</strong> ' + window.devicePixelRatio + '<br>' +
        '<strong>screen.width Ã— height:</strong> ' + screen.width + ' Ã— ' + screen.height + ' (CSS åƒç´ )<br>' +
        '<strong>window.screenX, screenY:</strong> ' + window.screenX + ', ' + window.screenY + ' (ç‰©ç†åƒç´ )<br>' +
        '<strong>window.innerWidth Ã— innerHeight:</strong> ' + window.innerWidth + ' Ã— ' + window.innerHeight + ' (CSS åƒç´ )<br>' +
        '<strong>AnyWP.dpiScale:</strong> ' + (window.AnyWP ? window.AnyWP.dpiScale : 'N/A') + '<br>' +
        '<strong>AnyWP.version:</strong> ' + (window.AnyWP ? window.AnyWP.version : 'N/A');
    }
    
    function waitForAnyWP() {
      if (window.AnyWP) {
        log('âœ… AnyWP SDK v' + AnyWP.version + ' å·²åŠ è½½');
        updateSystemInfo();
        setupDraggable();
      } else {
        setTimeout(waitForAnyWP, 100);
      }
    }
    
    function setupDraggable() {
      const box = document.getElementById('testBox');
      const rect = box.getBoundingClientRect();
      
      log('ğŸ“¦ å…ƒç´ åˆå§‹çŠ¶æ€:');
      log('  CSS ä½ç½®: left=' + rect.left.toFixed(1) + ', top=' + rect.top.toFixed(1));
      log('  CSS å°ºå¯¸: ' + rect.width.toFixed(1) + ' Ã— ' + rect.height.toFixed(1));
      log('  ç‰©ç†ä½ç½®: left=' + (rect.left * AnyWP.dpiScale).toFixed(0) + ', top=' + (rect.top * AnyWP.dpiScale).toFixed(0));
      log('  ç‰©ç†å°ºå¯¸: ' + (rect.width * AnyWP.dpiScale).toFixed(0) + ' Ã— ' + (rect.height * AnyWP.dpiScale).toFixed(0));
      
      // è®¡æ•°å™¨
      let mousedownCount = 0;
      let mousemoveCount = 0;
      let mouseupCount = 0;
      
      // å…¨å±€äº‹ä»¶ç›‘å¬å™¨ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      let globalMousemoveCount = 0;
      window.addEventListener('AnyWP:mouse', function(event) {
        if (event.detail.type === 'mousemove') {
          globalMousemoveCount++;
          if (globalMousemoveCount <= 3) {
            console.log('[GLOBAL] mousemove event #' + globalMousemoveCount + ' received in global handler');
          }
        }
      });
      
      // ç›‘å¬å…¨å±€é¼ æ ‡äº‹ä»¶
      window.addEventListener('AnyWP:mouse', function(event) {
        const detail = event.detail;
        const mouseX = detail.x;
        const mouseY = detail.y;
        const mouseType = detail.type;
        
        // ç»Ÿè®¡äº‹ä»¶æ•°é‡
        if (mouseType === 'mousedown') mousedownCount++;
        else if (mouseType === 'mousemove') mousemoveCount++;
        else if (mouseType === 'mouseup') mouseupCount++;
        
        // DEBUG: Log RAW coordinates from C++ (only for mousedown)
        if (mouseType === 'mousedown') {
          log('');
          log('ğŸ“¥ Raw event from C++: type=' + mouseType + ', x=' + mouseX + ', y=' + mouseY);
          log('  window.screenX=' + window.screenX + ', window.screenY=' + window.screenY);
        }
        
        if (mouseType === 'mousedown') {
          const rect = box.getBoundingClientRect();
          const physicalLeft = Math.round(rect.left * AnyWP.dpiScale);
          const physicalTop = Math.round(rect.top * AnyWP.dpiScale);
          const physicalRight = Math.round(rect.right * AnyWP.dpiScale);
          const physicalBottom = Math.round(rect.bottom * AnyWP.dpiScale);
          
          const isOver = mouseX >= physicalLeft && mouseX <= physicalRight &&
                         mouseY >= physicalTop && mouseY <= physicalBottom;
          
          log('');
          log('ğŸ–±ï¸ é¼ æ ‡ç‚¹å‡»äº‹ä»¶ (mousedown):');
          log('  é¼ æ ‡åæ ‡ (ç‰©ç†åƒç´ ): x=' + mouseX + ', y=' + mouseY);
          log('  å…ƒç´ è¾¹ç•Œ (ç‰©ç†åƒç´ ): [' + physicalLeft + ', ' + physicalTop + '] ~ [' + physicalRight + ', ' + physicalBottom + ']');
          log('  å…ƒç´ è¾¹ç•Œ (CSS åƒç´ ): [' + rect.left.toFixed(1) + ', ' + rect.top.toFixed(1) + '] ~ [' + rect.right.toFixed(1) + ', ' + rect.bottom.toFixed(1) + ']');
          log('  DPI ç¼©æ”¾: ' + AnyWP.dpiScale);
          log('  æ˜¯å¦åœ¨å…ƒç´ ä¸Š: ' + (isOver ? 'âœ… æ˜¯' : 'âŒ å¦'), !isOver);
          
          if (!isOver) {
            const distX = mouseX < physicalLeft ? (physicalLeft - mouseX) : (mouseX > physicalRight ? (mouseX - physicalRight) : 0);
            const distY = mouseY < physicalTop ? (physicalTop - mouseY) : (mouseY > physicalBottom ? (mouseY - physicalBottom) : 0);
            log('  åå·®: æ¨ªå‘=' + distX + 'px, çºµå‘=' + distY + 'px', true);
          }
        } else if (mouseType === 'mousemove') {
          // æ¯æ¬¡éƒ½è®°å½•ï¼Œä½†åªæ˜¾ç¤ºæœ€æ–°çš„ä¸€æ¡ï¼ˆè¦†ç›–ï¼‰
          const moveLine = document.getElementById('move-line');
          if (!moveLine) {
            const line = document.createElement('div');
            line.id = 'move-line';
            line.className = 'log-line';
            line.style.backgroundColor = '#2d2d30';
            logDiv.appendChild(line);
          }
          const dragInfo = AnyWP._dragState ? 
            'ACTIVE (offset: ' + AnyWP._dragState.offsetX + ',' + AnyWP._dragState.offsetY + ')' : 
            'null';
          document.getElementById('move-line').textContent = 
            'ğŸ“ mousemove äº‹ä»¶ #' + mousemoveCount + ': (' + mouseX + ', ' + mouseY + ') - dragState=' + dragInfo;
        } else if (mouseType === 'mouseup') {
          log('');
          log('ğŸ–±ï¸ é¼ æ ‡é‡Šæ”¾äº‹ä»¶ (mouseup):');
          log('  é¼ æ ‡åæ ‡ (ç‰©ç†åƒç´ ): x=' + mouseX + ', y=' + mouseY);
          log('  äº‹ä»¶ç»Ÿè®¡: mousedown=' + mousedownCount + ', mousemove=' + mousemoveCount + ', mouseup=' + mouseupCount);
        }
      });
      
      // è®¾ç½®æ‹–æ‹½
      AnyWP.makeDraggable('#testBox', {
        persistKey: 'test_box_position',
        onDragStart: function(pos) {
          log('ğŸ¯ å¼€å§‹æ‹–æ‹½: (' + pos.x.toFixed(1) + ', ' + pos.y.toFixed(1) + ')');
        },
        onDrag: function(pos) {
          // ä¸è®°å½•æ¯æ¬¡ç§»åŠ¨ä»¥é¿å…æ—¥å¿—è¿‡å¤š
        },
        onDragEnd: function(pos) {
          log('âœ‹ æ‹–æ‹½ç»“æŸ: (' + pos.x.toFixed(1) + ', ' + pos.y.toFixed(1) + ')');
        }
      });
      
      log('âœ… æ‹–æ‹½åŠŸèƒ½å·²å¯ç”¨');
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', waitForAnyWP);
    } else {
      waitForAnyWP();
    }
  </script>
</body>
</html>

