# AnyWP Engine - 测试指南

## 📋 测试前准备

### 1. 确认环境
- ✅ Windows 10/11
- ✅ WebView2 Runtime 已安装
- ✅ Flutter 已安装
- ✅ 项目已编译

### 2. 测试文件
项目在 `examples/` 目录包含多个测试 HTML 文件：
- `test_simple.html` - 简单测试（推荐首次测试）
- `test_api.html` - API 功能测试
- `test_iframe_ads.html` - iframe 广告检测测试

---

## 🧪 测试步骤

### 测试 1: 基础壁纸显示

**目的**: 验证壁纸能正确显示在桌面图标下方

**步骤**:
1. 运行 `anywallpaper_engine_example.exe`
2. URL 输入框应该已经填写了 `test_simple.html` 的路径
3. **确保 "Enable Mouse Transparent" 选中** (壁纸模式)
4. 点击 "Initialize Wallpaper" 按钮
5. **查看桌面** - 应该看到紫色渐变背景和时钟

**预期结果**:
- ✅ 桌面背景变为紫色渐变
- ✅ 看到 "AnyWallpaper Engine" 大标题
- ✅ 看到实时更新的时钟
- ✅ 桌面图标仍然可见且在壁纸上方
- ✅ 可以正常点击桌面图标

**失败排查**:
- 如果看不到壁纸，检查控制台输出
- 如果壁纸覆盖图标，这是 Win11 Z-order 问题
- 如果 URL 错误，修改为正确的文件路径

---

### 测试 2: 鼠标透传

**目的**: 验证在壁纸模式下鼠标可以穿透

**步骤**:
1. 在测试 1 的基础上
2. 尝试点击桌面图标
3. 尝试在桌面空白处右键菜单

**预期结果**:
- ✅ 桌面图标可以正常点击
- ✅ 桌面右键菜单正常弹出
- ✅ 鼠标事件完全穿透壁纸层

---

### 测试 3: 互动模式

**目的**: 验证互动模式下壁纸可以接收点击

**步骤**:
1. 点击 "Stop Wallpaper" 停止当前壁纸
2. **取消勾选 "Enable Mouse Transparent"** (互动模式)
3. 修改 URL 为 `test_api.html` 或 `https://www.bing.com`
4. 点击 "Initialize Wallpaper"
5. 尝试点击壁纸上的元素

**预期结果**:
- ✅ 鼠标 hover 在链接上有反馈
- ✅ 可以点击链接（通过鼠标hook透传）
- ✅ 桌面图标仍然可见
- ✅ 点击壁纸区域的空白处不会穿透到桌面

**注意**: 
- 互动模式下，壁纸区域的点击会被拦截并转发给 WebView
- 桌面图标仍然可以点击（通过窗口检测）

---

### 测试 4: URL 导航

**目的**: 验证运行时可以切换 URL

**步骤**:
1. 在壁纸运行状态下
2. 在 URL 输入框输入新地址:
   - `file:///E:/Projects/AnyWallpaper/AnyWallpaper Engine/examples/test_api.html`
   - 或 `https://www.bing.com`
3. 点击 "Navigate to URL" 按钮

**预期结果**:
- ✅ 壁纸内容切换到新 URL
- ✅ 不需要重新初始化
- ✅ 切换流畅无闪烁

---

### 测试 5: API Bridge

**目的**: 验证 JavaScript API 正常工作

**步骤**:
1. 使用 `test_api.html` 作为壁纸
2. 打开浏览器开发者工具（F12）
3. 查看控制台输出

**预期结果**:
- ✅ 看到 `[AnyWallpaper SDK] Initialized` 消息
- ✅ 看到交互模式状态日志
- ✅ API 测试按钮显示正常

**测试 API 方法**:
- `window.AnyWallpaper.log()` - 发送日志
- `window.AnyWallpaper.openUrl()` - 打开外部链接
- 查看事件监听是否正常

---

### 测试 6: iframe 广告检测

**目的**: 验证动态 iframe 点击检测

**步骤**:
1. 使用 `test_iframe_ads.html` 作为壁纸
2. **确保互动模式开启** (不勾选 "Enable Mouse Transparent")
3. 页面上会显示 4 个广告区域
4. 尝试点击每个广告

**预期结果**:
- ✅ 点击 "广告1" → 在浏览器中打开 `https://example.com`
- ✅ 点击 "广告2" → 打开 `https://google.com`
- ✅ 点击 "广告3" → 打开 `https://bing.com`
- ✅ 点击 "广告4" → 打开 `https://github.com`

**验证点击区域**:
- 控制台会显示 iframe 数据上报
- 点击时控制台显示点击坐标
- 点击正确的链接会在默认浏览器打开

---

### 测试 7: 导航后数据清理

**目的**: 验证导航后旧 iframe 数据被清除

**步骤**:
1. 使用 `test_iframe_ads.html` 并点击一些广告
2. 导航到 `test_simple.html`
3. 尝试点击之前广告的位置

**预期结果**:
- ✅ 切换页面后，旧的 iframe 数据被清除
- ✅ 点击新页面不会打开旧的广告链接
- ✅ 控制台显示 "Clearing X iframe(s) before navigation"

---

### 测试 8: 停止和重启

**目的**: 验证壁纸可以正常停止和重启

**步骤**:
1. 点击 "Stop Wallpaper"
2. 桌面恢复原始壁纸
3. 再次点击 "Initialize Wallpaper"

**预期结果**:
- ✅ Stop 后壁纸消失
- ✅ Stop 后桌面恢复正常
- ✅ 可以重新启动壁纸
- ✅ 资源正确释放（无内存泄漏）

---

### 测试 9: 多分辨率

**目的**: 验证在不同分辨率下正常工作

**步骤**:
1. 在当前分辨率下启动壁纸
2. 更改显示器分辨率或缩放比例
3. 观察壁纸是否自适应

**预期结果**:
- ✅ 壁纸铺满整个屏幕
- ✅ 分辨率改变后自动调整
- ✅ 高 DPI 显示器正常显示

---

## ✅ 完整测试清单

### 核心功能
- [ ] 壁纸初始化成功
- [ ] WebView2 内容正确显示
- [ ] 壁纸在图标下方（不覆盖）
- [ ] 鼠标透传正常
- [ ] 互动模式点击正常
- [ ] URL 导航功能正常
- [ ] 停止壁纸功能正常

### API 功能
- [ ] JavaScript API 可用
- [ ] 日志功能正常
- [ ] 打开 URL 功能正常
- [ ] 事件监听正常
- [ ] 交互模式事件正确

### 高级功能
- [ ] iframe 广告检测正常
- [ ] iframe 点击链接正确
- [ ] 导航清除旧数据
- [ ] 窗口遮挡检测正常
- [ ] 动态内容更新正常

### 性能和稳定性
- [ ] CPU 使用率 < 0.1% (空闲时)
- [ ] 内存使用稳定
- [ ] 无内存泄漏
- [ ] 长时间运行稳定

---

## 🐛 常见问题排查

### 问题 1: 壁纸不显示

**症状**: 点击 Initialize 后没有看到壁纸

**排查步骤**:
1. 查看控制台输出是否有 ERROR
2. 检查 WebView2 Runtime 是否安装
3. 确认 URL 路径正确
4. 尝试使用简单的 test_simple.html

**解决方案**:
```
- 安装 WebView2 Runtime
- 检查文件路径（file:/// 协议）
- 查看详细日志
```

### 问题 2: 壁纸覆盖了图标

**症状**: 看不到桌面图标

**原因**: Z-order 设置问题（Win11）

**解决方案**:
- 检查代码中 SetWindowPos 的调用
- 确认 SHELLDLL_DefView 的位置
- 查看控制台的 Z-order 日志

### 问题 3: 鼠标无法穿透

**症状**: 壁纸模式下无法点击桌面

**排查**:
- 确认 "Enable Mouse Transparent" 已勾选
- 检查 WS_EX_TRANSPARENT 样式
- 查看控制台的透传设置日志

### 问题 4: 互动模式点击无效

**症状**: 互动模式下点击壁纸无反应

**排查**:
- 确认鼠标 hook 已安装
- 查看控制台的 hook 相关日志
- 确认坐标转换是否正确

### 问题 5: iframe 点击打开错误链接

**症状**: 点击广告打开的不是对应链接

**原因**: 可能是导航后数据未清除

**解决方案**:
- 确认导航时清除了 iframe 数据
- 查看控制台的 iframe 清除日志
- 重新初始化壁纸

---

## 📊 性能基准

### CPU 使用率
- **空闲**: < 0.1%
- **加载中**: < 5%
- **视频播放**: < 10%

### 内存使用
- **初始**: ~50MB
- **运行中**: ~100MB
- **增长率**: < 1MB/小时

### 启动时间
- **初始化**: < 1s
- **WebView2 创建**: < 2s
- **首屏渲染**: < 3s

---

## 📝 测试报告模板

```
测试日期: YYYY-MM-DD
测试人: 
操作系统: Windows 11 (10.0.26100)
Flutter 版本: 
WebView2 版本: 1.0.2592.51

测试结果:
[ ] 测试 1: 基础壁纸显示 - PASS/FAIL
[ ] 测试 2: 鼠标透传 - PASS/FAIL
[ ] 测试 3: 互动模式 - PASS/FAIL
[ ] 测试 4: URL 导航 - PASS/FAIL
[ ] 测试 5: API Bridge - PASS/FAIL
[ ] 测试 6: iframe 广告检测 - PASS/FAIL
[ ] 测试 7: 导航数据清理 - PASS/FAIL
[ ] 测试 8: 停止和重启 - PASS/FAIL
[ ] 测试 9: 多分辨率 - PASS/FAIL

问题记录:
1. 

性能数据:
- CPU 使用率: %
- 内存使用: MB
- 启动时间: s

总结:
```

---

## 🎯 测试建议

1. **按顺序测试**: 从测试 1 开始，确保基础功能正常
2. **查看日志**: 控制台输出包含详细的调试信息
3. **多次测试**: 每个功能测试 2-3 次确保稳定性
4. **不同 URL**: 测试本地文件和网络 URL
5. **长时间运行**: 测试至少运行 30 分钟检查稳定性

---

**测试成功标准**: 所有 9 项测试 PASS

**测试完成**: ✅ / ❌

