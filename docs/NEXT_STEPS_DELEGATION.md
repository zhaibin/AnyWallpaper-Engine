# Next Steps - Method Delegation Plan

## 当前状态

### 已完成 ✅
- PowerManager 模块集成（构造/析构）
- MonitorManager 模块集成（构造/析构）
- MouseHookManager 模块集成（构造/析构）
- PowerManager 接口重新设计（3个方法改为 public）
- 2个方法已委托：`UpdatePowerState()`, `IsFullscreenAppActive()`

### 主文件现状
- **总行数**: ~4200 行
- **已委托**: 2 个方法
- **待委托**: ~30+ 个方法

---

## 阶段 A: Power 方法委托（优先级最高）

### A1. 辅助方法委托（简单）
| 方法名 | 行数估计 | 复杂度 | 优先级 |
|--------|---------|--------|--------|
| `ShouldWallpaperBeActive()` | ~50 | 低 | P0 |
| `GetCurrentMemoryUsage()` | ~20 | 低 | P0 |
| `OptimizeMemoryUsage()` | ~30 | 中 | P0 |

### A2. 检测线程方法委托（中等）
| 方法名 | 行数估计 | 复杂度 | 优先级 |
|--------|---------|--------|--------|
| `StartFullscreenDetection()` | ~40 | 中 | P1 |
| `StopFullscreenDetection()` | ~20 | 低 | P1 |

### A3. 监听设置方法委托（复杂）
| 方法名 | 行数估计 | 复杂度 | 优先级 |
|--------|---------|--------|--------|
| `SetupPowerSavingMonitoring()` | ~100 | 高 | P2 |
| `CleanupPowerSavingMonitoring()` | ~50 | 中 | P2 |

**预计时间**: 1-2 小时  
**预计减少行数**: ~300 行

---

## 阶段 B: Monitor 方法委托（优先级高）

### B1. 枚举方法委托（简单）
| 方法名 | 行数估计 | 复杂度 | 优先级 |
|--------|---------|--------|--------|
| `GetMonitors()` | ~80 | 中 | P0 |
| `GetPrimaryMonitor()` | ~30 | 低 | P0 |

### B2. 监听方法委托（复杂）
| 方法名 | 行数估计 | 复杂度 | 优先级 |
|--------|---------|--------|--------|
| `SetupDisplayChangeListener()` | ~100 | 高 | P1 |
| `CleanupDisplayChangeListener()` | ~50 | 中 | P1 |
| `HandleDisplayChange()` | ~80 | 高 | P1 |

**预计时间**: 1-2 小时  
**预计减少行数**: ~300 行

---

## 阶段 C: Mouse 方法委托（优先级高）

### C1. 钩子管理方法委托（中等）
| 方法名 | 行数估计 | 复杂度 | 优先级 |
|--------|---------|--------|--------|
| `SetupMouseHook()` | ~100 | 高 | P0 |
| `RemoveMouseHook()` | ~30 | 低 | P0 |

### C2. 回调方法委托（复杂）
| 方法名 | 行数估计 | 复杂度 | 优先级 |
|--------|---------|--------|--------|
| `MouseProc()` (静态) | ~300 | 非常高 | P1 |
| `FindIframeAtPosition()` | ~50 | 中 | P1 |
| `GetWallpaperInstanceAtPosition()` | ~40 | 中 | P1 |

**预计时间**: 2-3 小时  
**预计减少行数**: ~500 行

---

## 阶段 D: 创建新模块（优先级中等）

### D1. WebViewManager 模块
**负责功能**:
- WebView2 生命周期管理
- WebView2 配置和初始化
- JavaScript 注入和消息桥接
- 权限请求处理

**预计方法数**: ~15 个  
**预计代码量**: ~800 行  
**预计时间**: 3-4 小时

### D2. WallpaperInstanceManager 模块
**负责功能**:
- 多壁纸实例管理
- 实例创建和销毁
- 实例查询和枚举
- 实例状态同步

**预计方法数**: ~10 个  
**预计代码量**: ~500 行  
**预计时间**: 2-3 小时

### D3. WindowManager 模块
**负责功能**:
- 窗口创建和管理
- 窗口层级控制
- 窗口父子关系
- 窗口位置和大小

**预计方法数**: ~8 个  
**预计代码量**: ~400 行  
**预计时间**: 2 小时

### D4. ConflictDetector 模块
**负责功能**:
- 检测其他壁纸软件
- 检测窗口冲突
- 提供警告和建议
- 自动避让机制

**预计方法数**: ~6 个  
**预计代码量**: ~300 行  
**预计时间**: 1-2 小时

**预计总时间**: 8-11 小时  
**预计减少行数**: ~2000 行

---

## 阶段 E: 代码清理（最后阶段）

### E1. 删除重复代码
- 验证所有委托方法正常工作
- 删除 legacy 实现（保留必要的 fallback）
- 合并重复的辅助函数

### E2. 删除冗余成员变量
- 删除已迁移到模块的成员变量
- 使用模块的状态管理

### E3. 简化头文件
- 删除不再需要的前向声明
- 删除不再需要的 include
- 重新组织类定义

### E4. 更新文档
- 更新 API 文档
- 更新架构图
- 更新开发者指南

**预计时间**: 2-3 小时  
**预计减少行数**: ~1000 行

---

## 最终目标

### 主文件大小目标
- **当前**: ~4200 行
- **阶段 A-C 后**: ~3100 行（减少 26%）
- **阶段 D 后**: ~1100 行（减少 74%）
- **阶段 E 后**: ~800 行（减少 81%）

### 模块化程度目标
- **当前**: 3 个模块（Power, Monitor, Mouse）
- **最终**: 7 个模块（+ WebView, Instance, Window, Conflict）

### 代码质量目标
- ✅ 所有模块独立可测试
- ✅ 所有模块职责单一
- ✅ 主文件只负责协调
- ✅ 所有错误处理完整

---

## 执行建议

### 推荐执行顺序
1. **阶段 A**: Power 方法委托（P0, P1 优先）
2. **阶段 B**: Monitor 方法委托
3. **阶段 C**: Mouse 方法委托（P0 优先）
4. **阶段 D**: 创建新模块（按需）
5. **阶段 E**: 代码清理（最后）

### 风险管理
- 每完成一个方法委托，立即编译测试
- 每完成一个阶段，创建 Git commit
- 遇到问题立即回滚，保持稳定性
- 保留 legacy 实现作为 fallback

### 质量保证
- 每个委托方法必须有异常处理
- 每个委托方法必须有 fallback 机制
- 每个新模块必须有单元测试
- 每次提交必须编译通过

---

## 时间预估

### 保守估计
- 阶段 A: 2 小时
- 阶段 B: 2 小时
- 阶段 C: 3 小时
- 阶段 D: 11 小时
- 阶段 E: 3 小时
- **总计**: 21 小时

### 乐观估计
- 阶段 A: 1 小时
- 阶段 B: 1 小时
- 阶段 C: 2 小时
- 阶段 D: 8 小时
- 阶段 E: 2 小时
- **总计**: 14 小时

---

## 结论

通过系统化的分阶段重构，我们可以将主文件从 4200 行减少到 800 行左右，同时保持系统稳定性和向后兼容性。每个阶段都是独立可验证的，风险可控。

**建议立即开始阶段 A**，因为 Power 方法委托最简单且最有价值。

