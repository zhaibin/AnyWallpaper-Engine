# AnyWP Engine - Cursor Rules

## 项目概览
Flutter Windows 插件，将 WebView2 嵌入为交互式桌面壁纸（显示在桌面图标后方）。

**技术栈**: Flutter 3.0+ | C++17 | WebView2 | CMake | TypeScript  
**命名**: 包名 `anywp_engine` | 类名 `AnyWPEngine` `AnyWPEnginePlugin`  
**核心功能**: 壁纸嵌入 | 鼠标交互 | 元素拖拽 | 应用级存储隔离 | 省电优化

---

## 编码规范

### Dart
- 类 `UpperCamelCase` | 方法 `lowerCamelCase` | 文件 `snake_case.dart`
- 公共 API 需文档注释 | 异步用 `Future<T>` | 使用 `flutter_lints`

### C++
- 类/方法 `PascalCase` | 成员变量 `snake_case_` | 常量 `UPPER_SNAKE_CASE`
- 使用智能指针管理 COM | RAII 管理资源 | 检查 Win32 API 返回值
- **模块化设计**: 按功能拆分为独立模块（`modules/`）和工具类（`utils/`）
- **错误处理**: 所有关键操作使用 try-catch，回调添加异常保护
- **日志记录**: 使用 `Logger::Instance()` 统一记录，支持多级别和线程安全
- **单元测试**: 新功能需添加测试用例到 `windows/test/`（覆盖率 ≥95%）

### TypeScript/JavaScript
- 全局 `window.AnyWP` | 方法 `lowerCamelCase`
- **TypeScript SDK**: 100% TypeScript，模块化架构，类型定义在 `windows/sdk/types.ts`
- 使用严格模式 (`strict: true`)

---

## 文件组织

```
lib/                    # Dart API
windows/                # C++ 实现 + anywp_sdk.js
  ├── modules/          # 核心功能模块（13个）
  ├── utils/            # 工具类（12个）
  ├── test/             # C++ 单元测试
  ├── sdk/              # TypeScript SDK 源码
  └── anywp_engine_plugin.cpp/h  # 主插件实现
example/                # 示例应用
examples/               # 测试 HTML
docs/                   # 核心文档
scripts/                # 构建脚本
release/                # 发布包
```

---

## 核心文档

**面向开发者**:
- Flutter: `docs/FOR_FLUTTER_DEVELOPERS.md` + `docs/DEVELOPER_API_REFERENCE.md`
- Web: `docs/WEB_DEVELOPER_GUIDE_CN.md`
- 集成: `docs/PRECOMPILED_DLL_INTEGRATION.md`

**技术文档**: `docs/TECHNICAL_NOTES.md` | `docs/API_BRIDGE.md`

---

## 开发流程

### 功能开发
1. **实现功能**: 编写代码 + 完整错误处理 + 文档注释
2. **本地测试**: 
   - C++: `cd windows\test && run_tests.bat`
   - Web SDK: `cd windows\sdk && npm test`
   - 集成: `.\scripts\test_full.bat`
3. **代码检查**: `flutter analyze` 确保无警告
4. **自动提交**: 使用文件方式提交中文信息

**质量标准**:
- [ ] 所有公共 API 有文档注释
- [ ] 关键操作有 try-catch 保护
- [ ] 单元测试覆盖率 ≥95%
- [ ] 无 Linter 警告或错误

### Web SDK 开发
**开发步骤**:
1. 修改 TypeScript 源码 (`windows/sdk/`)
2. 运行单元测试: `cd windows\sdk && npm test`
3. 构建生产 SDK: `npm run build` (生成 `windows/anywp_sdk.js`)
4. 在 Flutter WebView2 中测试: `.\scripts\test_full.bat`
5. 提交: 同时提交 TS 源码和构建产物

**快速构建**: `.\scripts\build_sdk.bat` 或 `cd windows\sdk && npm run build`

**⚠️ 重要提示**:
- SDK 功能依赖 WebView2 Native 桥接（`chrome.webview.postMessage`）
- 必须在 Flutter 应用中测试，不要创建浏览器测试脚本

### 调试流程
1. 编译运行：`.\scripts\debug.bat`
2. 查看日志：`test_logs/debug_run.log` 或 `test_logs/test_full_*.log`
3. 实时监控：`.\scripts\monitor_log.bat` (可选)

**日志约定**: 所有测试和调试日志统一放在 `test_logs/` 目录下

---

## 发版流程

### Step 1: 版本号更新
- [ ] `pubspec.yaml`: `version: x.x.x`
- [ ] `CHANGELOG_CN.md`: 添加新版本条目
- [ ] `.cursorrules` 底部版本号
- [ ] `docs/PRECOMPILED_DLL_INTEGRATION.md`: 更新示例版本号

### Step 2: 文档更新
**新增 API 必须更新**:
- [ ] `lib/anywp_engine.dart` - 文档注释
- [ ] `README.md` - 示例代码
- [ ] `docs/DEVELOPER_API_REFERENCE.md` - API 章节
- [ ] `docs/FOR_FLUTTER_DEVELOPERS.md` - API 列表

**新增功能必须更新**:
- [ ] `README.md` - Features 章节
- [ ] `CHANGELOG_CN.md` - 更新日志条目

### Step 3: 编译测试
```bash
cd example
flutter clean
flutter pub get
flutter build windows --debug
flutter build windows --release
.\scripts\test_full.bat
```

**检查清单**:
- [ ] Debug/Release 构建成功
- [ ] 无 Linter 警告：`flutter analyze`
- [ ] 功能测试通过（至少 2 个测试页面）
- [ ] 验证 .lib 文件已生成

### Step 4: 构建发布包
```bash
.\scripts\release.bat
```

**构建后检查**:
- [ ] 构建成功（ERROR_COUNT = 0）
- [ ] DLL/LIB 文件生成
- [ ] 生成 3 个 ZIP 文件：
  - `anywp_engine_v{版本号}_precompiled.zip` - 预编译包（DLL + LIB + C API 头文件）
  - `anywp_engine_v{版本号}_source.zip` - 完整源码包
  - `anywp_web_sdk_v{版本号}.zip` - Web SDK 包

**⚠️ 预编译包验证**（必须全部存在）:
- `bin/anywp_engine_plugin.dll` + `bin/WebView2Loader.dll`
- `lib/anywp_engine_plugin.lib` ⚠️ 最易遗漏
- `lib/dart/anywp_engine.dart`
- `include/anywp_engine/anywp_engine_plugin_c_api.h` ⚠️ 新增纯C API头文件
- `windows/CMakeLists.txt`

**⚠️ 源码包验证**（额外包含）:
- `windows/anywp_engine_plugin.cpp/h` - 完整 C++ 源码
- `windows/modules/` + `windows/utils/` - 所有模块和工具类
- `windows/sdk/` + `windows/anywp_sdk.js` - TypeScript SDK 源码
- `windows/packages/` - WebView2 依赖包

**验证命令**: `.\scripts\verify_precompiled.bat {版本号}`

### Step 5: Git 提交与推送
```bash
git add release/ CHANGELOG_CN.md pubspec.yaml docs/ README.md .cursorrules

# 中文提交使用文件方式（避免乱码）
echo release: 发布 v{版本号} - 功能描述 > commit_msg.txt
echo. >> commit_msg.txt
echo 详细说明 >> commit_msg.txt
git commit -F commit_msg.txt
del commit_msg.txt

git push origin main

# 创建并推送 Tag
git tag -a v{版本号} -m "AnyWP Engine v{版本号}"
git push origin v{版本号}
```

### Step 6: GitHub Release
1. 访问: `https://github.com/zhaibin/AnyWallpaper-Engine/releases/new`
2. Tag: `v{版本号}` | Title: `AnyWP Engine v{版本号}`
3. Description: 复制 `release/GITHUB_RELEASE_NOTES_v{版本号}.md`
4. 上传 3 个 ZIP 文件：
   - `anywp_engine_v{版本号}_precompiled.zip` - **推荐给 Flutter 开发者**
   - `anywp_engine_v{版本号}_source.zip` - 完整源码（高级用户）
   - `anywp_web_sdk_v{版本号}.zip` - Web 壁纸开发者
5. 勾选 "Set as the latest release"

**包说明**：
- **Precompiled**: 最简单的集成方式，只包含必要的 DLL、LIB 和纯 C API 头文件，无需 WebView2 开发环境
- **Source**: 包含完整源码、模块、工具类和 WebView2 依赖，适合需要自定义修改的开发者
- **Web SDK**: 独立的 JavaScript SDK，供 HTML 壁纸开发者使用

---

## AI 工作流规范

### 基本原则
- **默认中文回复**（技术术语保留英文）
- **直接实现**，避免冗长解释
- **自动调试**：编译、运行、读日志、优化
- **自动提交**：功能完成后自动 git commit
- **不创建过程性文档**（测试报告、验证报告等）

### 代码质量要求
- **所有公共 API**: 必须有完整的文档注释
- **错误处理**: 所有关键操作使用 try-catch
- **日志记录**: 使用统一日志接口（`Logger::Instance()`）
- **单元测试**: 新功能必须添加测试用例（覆盖率 ≥95%）

### 开发优先级
1. **功能正确性** > 性能优化
2. **代码可读性** > 简洁性
3. **错误处理完整性** > 功能丰富度
4. **测试覆盖率** > 开发速度

---

## Git 提交规范

**提交信息格式**:
```
<type>(<scope>): <subject>

<body>
```

**Type**: `feat` | `fix` | `docs` | `refactor` | `chore` | `release`

**中文提交（必须使用文件方式）**:
```bash
echo "feat: 添加新功能" > commit_msg.txt
echo "" >> commit_msg.txt
echo "详细说明" >> commit_msg.txt
git commit -F commit_msg.txt
del commit_msg.txt
```

**禁止**: `git commit -m "中文信息"` ❌ 会乱码

---

## PowerShell 注意事项

**🚫 严禁使用的语法**:

1. **❌ 使用 && 操作符** - PowerShell 不支持
   ```powershell
   # ❌ 错误
   command1 && command2
   
   # ✅ 正确：使用分号或换行
   command1; command2
   # 或
   command1
   command2
   ```

2. **❌ Here-String (`@" ... "@`)** - 会导致编码问题

3. **❌ 中文字符串中的特殊符号** - 会导致解析错误

**✅ 推荐做法**:
- **优先使用批处理脚本（.bat）** 处理复杂逻辑和中文文本
- **PowerShell 仅用于简单命令**: Test-Path, Copy-Item, Remove-Item（无中文输出）
- **中文提交信息**: 使用 `echo > file` 或批处理脚本，**禁止 Here-String**

---

## 常用命令

```bash
# 开发
.\scripts\build.bat       # 构建并运行
.\scripts\run.bat         # 快速运行
.\scripts\debug.bat       # 调试模式

# 测试
.\scripts\test_full.bat   # 全面测试
cd windows\sdk && npm test # TypeScript 单元测试
cd windows\test && run_tests.bat  # C++ 单元测试

# SDK
.\scripts\build_sdk.bat   # 构建 Web SDK

# 发布
.\scripts\release.bat     # 构建 Release 包
.\scripts\verify_release.bat {版本号}  # 验证发布包
```

**日志目录**: `test_logs/` (所有测试和调试日志统一存放)

---

## 代码架构

### C++ 模块化设计
- **核心模块** (`windows/modules/`): 12个功能模块
- **工具类** (`windows/utils/`): 12个工具类（含3个header-only）
- **测试框架** (`windows/test/`): 轻量级测试框架 + 单元测试

**设计原则**:
1. **单一职责**: 每个模块只负责一个核心功能
2. **低耦合**: 模块之间通过接口交互
3. **易测试**: 独立模块便于单元测试
4. **完整文档**: 所有公共接口需要文档注释
5. **错误恢复**: 关键操作使用 RetryHandler 和 CircuitBreaker

**添加新模块步骤**:
1. 创建 `windows/modules/module_name.h/cpp` 或 `windows/utils/utility_name.h/cpp`
2. 实现功能并遵循命名规范
3. 添加完整的错误处理（try-catch）和日志记录（Logger::Instance()）
4. 更新 `windows/CMakeLists.txt`
5. 添加单元测试（覆盖率 ≥95%）
6. 更新 CHANGELOG_CN.md

---

## 文档维护原则

### 文档语言规范
- **根目录文档**: `README.md`、`QUICK_INTEGRATION.md`、`LICENSE` 必须全英文
- **中文文档**: 仅限 `docs/` 目录和 `CHANGELOG_CN.md`
- **GitHub Release Notes**: 建议英文或中英双语

### 禁止创建的文档
- ❌ `TEST_REPORT.md`
- ❌ `VERIFICATION_REPORT.md`
- ❌ `CHECKLIST.md`
- ❌ `SUMMARY.md`

**原则**: 测试、验证等过程在代码中完成，不生成报告文档

---

**版本**: 2.1.2 | **更新**: 2025-11-13
